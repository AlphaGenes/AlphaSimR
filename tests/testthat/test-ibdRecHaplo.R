context("ibdRecHaplo")

test_that("getIbdRecHist converts recHist & pedigree to ibdRecHist correctly", {
  
  # A simple pedigree
  pedigree = matrix(data = 0L, nrow = 7, ncol = 2)
  pedigree[5, 1:2] = c(1L, 2L)
  pedigree[6, 1:2] = c(3L, 4L)
  pedigree[7, 1:2] = c(5L, 6L)
  
  # Recombinations (as they are stored in simParam$recHist)
  recHist = vector(mode = "list", length = "7")
  # 2 chromosomes
  recHist[[5]] = recHist[[6]] = recHist[[7]] = vector(mode = "list", length = "2")
  # 2 gametes of a chromosome
  recHist[[5]][[1]] = recHist[[5]][[2]] = 
    recHist[[6]][[1]] = recHist[[6]][[2]] =
    recHist[[7]][[1]] = recHist[[7]][[2]] = vector(mode = "list", length = "2")
  # ind 5
  recHist[[5]][[1]][[1]] = matrix(data = 0L, nrow = 5, ncol = 2)
  recHist[[5]][[1]][[1]][1, 1:2] = c(1L, 1L)
  recHist[[5]][[1]][[1]][2, 1:2] = c(2L, 10L)
  recHist[[5]][[1]][[1]][3, 1:2] = c(1L, 50L)
  recHist[[5]][[1]][[1]][4, 1:2] = c(2L, 100L)
  recHist[[5]][[1]][[1]][5, 1:2] = c(1L, 150L)
  recHist[[5]][[1]][[2]] = matrix(data = 0L, nrow = 5, ncol = 2)
  recHist[[5]][[1]][[2]][1, 1:2] = c(2L, 1L)
  recHist[[5]][[1]][[2]][2, 1:2] = c(1L, 5L)
  recHist[[5]][[1]][[2]][3, 1:2] = c(2L, 10L)
  recHist[[5]][[1]][[2]][4, 1:2] = c(1L, 15L)
  recHist[[5]][[1]][[2]][5, 1:2] = c(2L, 20L)
  recHist[[5]][[2]][[1]] = matrix(data = 0L, nrow = 10, ncol = 2)
  recHist[[5]][[2]][[1]][ 1, 1:2] = c(1L, 1L)
  recHist[[5]][[2]][[1]][ 2, 1:2] = c(2L, 2L)
  recHist[[5]][[2]][[1]][ 3, 1:2] = c(1L, 3L)
  recHist[[5]][[2]][[1]][ 4, 1:2] = c(2L, 4L)
  recHist[[5]][[2]][[1]][ 5, 1:2] = c(1L, 5L)
  recHist[[5]][[2]][[1]][ 6, 1:2] = c(2L, 6L)
  recHist[[5]][[2]][[1]][ 7, 1:2] = c(1L, 7L)
  recHist[[5]][[2]][[1]][ 8, 1:2] = c(2L, 8L)
  recHist[[5]][[2]][[1]][ 9, 1:2] = c(1L, 9L)
  recHist[[5]][[2]][[1]][10, 1:2] = c(2L, 10L)
  recHist[[5]][[2]][[2]] = matrix(data = 0L, nrow = 10, ncol = 2)
  recHist[[5]][[2]][[2]][ 1, 1:2] = c(2L, 1L)
  recHist[[5]][[2]][[2]][ 2, 1:2] = c(1L, 3L)
  recHist[[5]][[2]][[2]][ 3, 1:2] = c(2L, 5L)
  recHist[[5]][[2]][[2]][ 4, 1:2] = c(1L, 7L)
  recHist[[5]][[2]][[2]][ 5, 1:2] = c(2L, 9L)
  recHist[[5]][[2]][[2]][ 6, 1:2] = c(1L, 11L)
  recHist[[5]][[2]][[2]][ 7, 1:2] = c(2L, 13L)
  recHist[[5]][[2]][[2]][ 8, 1:2] = c(1L, 15L)
  recHist[[5]][[2]][[2]][ 9, 1:2] = c(2L, 17L)
  recHist[[5]][[2]][[2]][10, 1:2] = c(1L, 19L)
  # ind 6
  recHist[[6]][[1]][[1]] = matrix(data = 0L, nrow = 4, ncol = 2)
  recHist[[6]][[1]][[1]][1, 1:2] = c(2L, 1L)
  recHist[[6]][[1]][[1]][2, 1:2] = c(1L, 150L)
  recHist[[6]][[1]][[1]][3, 1:2] = c(2L, 200L)
  recHist[[6]][[1]][[1]][4, 1:2] = c(1L, 250L)
  recHist[[6]][[1]][[2]] = matrix(data = 0L, nrow = 5, ncol = 2)
  recHist[[6]][[1]][[2]][1, 1:2] = c(2L, 1L)
  recHist[[6]][[1]][[2]][2, 1:2] = c(1L, 9L)
  recHist[[6]][[1]][[2]][3, 1:2] = c(2L, 11L)
  recHist[[6]][[1]][[2]][4, 1:2] = c(1L, 50L)
  recHist[[6]][[1]][[2]][5, 1:2] = c(2L, 100L)
  recHist[[6]][[2]][[1]] = matrix(data = 0L, nrow = 11, ncol = 2)
  recHist[[6]][[2]][[1]][ 1, 1:2] = c(1L, 1L)
  recHist[[6]][[2]][[1]][ 2, 1:2] = c(2L, 10L)
  recHist[[6]][[2]][[1]][ 3, 1:2] = c(1L, 20L)
  recHist[[6]][[2]][[1]][ 4, 1:2] = c(2L, 30L)
  recHist[[6]][[2]][[1]][ 5, 1:2] = c(1L, 40L)
  recHist[[6]][[2]][[1]][ 6, 1:2] = c(2L, 50L)
  recHist[[6]][[2]][[1]][ 7, 1:2] = c(1L, 60L)
  recHist[[6]][[2]][[1]][ 8, 1:2] = c(2L, 70L)
  recHist[[6]][[2]][[1]][ 9, 1:2] = c(1L, 80L)
  recHist[[6]][[2]][[1]][10, 1:2] = c(2L, 90L)
  recHist[[6]][[2]][[1]][11, 1:2] = c(1L, 100L)
  recHist[[6]][[2]][[2]] = matrix(data = 0L, nrow = 6, ncol = 2)
  recHist[[6]][[2]][[2]][1, 1:2] = c(2L, 1L)
  recHist[[6]][[2]][[2]][2, 1:2] = c(1L, 50L)
  recHist[[6]][[2]][[2]][3, 1:2] = c(2L, 100L)
  recHist[[6]][[2]][[2]][4, 1:2] = c(1L, 150L)
  recHist[[6]][[2]][[2]][5, 1:2] = c(2L, 200L)
  recHist[[6]][[2]][[2]][6, 1:2] = c(1L, 250L)
  # ind 7
  recHist[[7]][[1]][[1]] = matrix(data = 0L, nrow = 6, ncol = 2)
  recHist[[7]][[1]][[1]][1, 1:2] = c(2L, 1L)
  recHist[[7]][[1]][[1]][2, 1:2] = c(1L, 6L)
  recHist[[7]][[1]][[1]][3, 1:2] = c(2L, 10L)
  recHist[[7]][[1]][[1]][4, 1:2] = c(1L, 45L)
  recHist[[7]][[1]][[1]][5, 1:2] = c(2L, 110L)
  recHist[[7]][[1]][[1]][6, 1:2] = c(1L, 140L)
  recHist[[7]][[1]][[2]] = matrix(data = 0L, nrow = 1, ncol = 2)
  recHist[[7]][[1]][[2]][1, 1:2] = c(2L, 1L)
  recHist[[7]][[2]][[1]] = matrix(data = 0L, nrow = 6, ncol = 2)
  recHist[[7]][[2]][[1]][1, 1:2] = c(2L, 1L)
  recHist[[7]][[2]][[1]][2, 1:2] = c(1L, 6L)
  recHist[[7]][[2]][[1]][3, 1:2] = c(2L, 10L)
  recHist[[7]][[2]][[1]][4, 1:2] = c(1L, 45L)
  recHist[[7]][[2]][[1]][5, 1:2] = c(2L, 110L)
  recHist[[7]][[2]][[1]][6, 1:2] = c(1L, 140L)
  recHist[[7]][[2]][[2]] = matrix(data = 0L, nrow = 7, ncol = 2)
  recHist[[7]][[2]][[2]][1, 1:2] = c(1L, 1L)
  recHist[[7]][[2]][[2]][2, 1:2] = c(2L, 50L)
  recHist[[7]][[2]][[2]][3, 1:2] = c(1L, 75L)
  recHist[[7]][[2]][[2]][4, 1:2] = c(2L, 99L)
  recHist[[7]][[2]][[2]][5, 1:2] = c(1L, 101L)
  recHist[[7]][[2]][[2]][6, 1:2] = c(2L, 149L)
  recHist[[7]][[2]][[2]][7, 1:2] = c(1L, 151L)
  
  # IBD recombinations (since the base generation)
  expect = recHist
  # ind 1
  expect[[1]][[1]][[1]] = matrix(data = c(1L, 1L), nrow = 1, ncol = 2)
  expect[[1]][[1]][[2]] = matrix(data = c(2L, 1L), nrow = 1, ncol = 2)
  expect[[1]][[2]] = expect[[1]][[1]]
  # ind 2
  expect[[2]][[1]][[1]] = matrix(data = c(3L, 1L), nrow = 1, ncol = 2)
  expect[[2]][[1]][[2]] = matrix(data = c(4L, 1L), nrow = 1, ncol = 2)
  expect[[2]][[2]] = expect[[2]][[1]]
  # ind 3
  expect[[3]][[1]][[1]] = matrix(data = c(5L, 1L), nrow = 1, ncol = 2)
  expect[[3]][[1]][[2]] = matrix(data = c(6L, 1L), nrow = 1, ncol = 2)
  expect[[3]][[2]] = expect[[3]][[1]]
  # ind 4
  expect[[4]][[1]][[1]] = matrix(data = c(7L, 1L), nrow = 1, ncol = 2)
  expect[[4]][[1]][[2]] = matrix(data = c(8L, 1L), nrow = 1, ncol = 2)
  expect[[4]][[2]] = expect[[4]][[1]]
  # ind 5
  expect[[5]][[1]][[1]] = matrix(data = 0L, nrow = 5, ncol = 2)
  expect[[5]][[1]][[1]][1, 1:2] = c(1L, 1L)
  expect[[5]][[1]][[1]][2, 1:2] = c(2L, 10L)
  expect[[5]][[1]][[1]][3, 1:2] = c(1L, 50L)
  expect[[5]][[1]][[1]][4, 1:2] = c(2L, 100L)
  expect[[5]][[1]][[1]][5, 1:2] = c(1L, 150L)
  expect[[5]][[1]][[2]] = matrix(data = 0L, nrow = 5, ncol = 2)
  expect[[5]][[1]][[2]][1, 1:2] = c(4L, 1L)
  expect[[5]][[1]][[2]][2, 1:2] = c(3L, 5L)
  expect[[5]][[1]][[2]][3, 1:2] = c(4L, 10L)
  expect[[5]][[1]][[2]][4, 1:2] = c(3L, 15L)
  expect[[5]][[1]][[2]][5, 1:2] = c(4L, 20L)
  expect[[5]][[2]][[1]] = matrix(data = 0L, nrow = 10, ncol = 2)
  expect[[5]][[2]][[1]][ 1, 1:2] = c(1L, 1L)
  expect[[5]][[2]][[1]][ 2, 1:2] = c(2L, 2L)
  expect[[5]][[2]][[1]][ 3, 1:2] = c(1L, 3L)
  expect[[5]][[2]][[1]][ 4, 1:2] = c(2L, 4L)
  expect[[5]][[2]][[1]][ 5, 1:2] = c(1L, 5L)
  expect[[5]][[2]][[1]][ 6, 1:2] = c(2L, 6L)
  expect[[5]][[2]][[1]][ 7, 1:2] = c(1L, 7L)
  expect[[5]][[2]][[1]][ 8, 1:2] = c(2L, 8L)
  expect[[5]][[2]][[1]][ 9, 1:2] = c(1L, 9L)
  expect[[5]][[2]][[1]][10, 1:2] = c(2L, 10L)
  expect[[5]][[2]][[2]] = matrix(data = 0L, nrow = 10, ncol = 2)
  expect[[5]][[2]][[2]][ 1, 1:2] = c(4L, 1L)
  expect[[5]][[2]][[2]][ 2, 1:2] = c(3L, 3L)
  expect[[5]][[2]][[2]][ 3, 1:2] = c(4L, 5L)
  expect[[5]][[2]][[2]][ 4, 1:2] = c(3L, 7L)
  expect[[5]][[2]][[2]][ 5, 1:2] = c(4L, 9L)
  expect[[5]][[2]][[2]][ 6, 1:2] = c(3L, 11L)
  expect[[5]][[2]][[2]][ 7, 1:2] = c(4L, 13L)
  expect[[5]][[2]][[2]][ 8, 1:2] = c(3L, 15L)
  expect[[5]][[2]][[2]][ 9, 1:2] = c(4L, 17L)
  expect[[5]][[2]][[2]][10, 1:2] = c(3L, 19L)
  # ind 6
  expect[[6]][[1]][[1]] = matrix(data = 0L, nrow = 4, ncol = 2)
  expect[[6]][[1]][[1]][1, 1:2] = c(6L, 1L)
  expect[[6]][[1]][[1]][2, 1:2] = c(5L, 150L)
  expect[[6]][[1]][[1]][3, 1:2] = c(6L, 200L)
  expect[[6]][[1]][[1]][4, 1:2] = c(5L, 250L)
  expect[[6]][[1]][[2]] = matrix(data = 0L, nrow = 5, ncol = 2)
  expect[[6]][[1]][[2]][1, 1:2] = c(8L, 1L)
  expect[[6]][[1]][[2]][2, 1:2] = c(7L, 9L)
  expect[[6]][[1]][[2]][3, 1:2] = c(8L, 11L)
  expect[[6]][[1]][[2]][4, 1:2] = c(7L, 50L)
  expect[[6]][[1]][[2]][5, 1:2] = c(8L, 100L)
  expect[[6]][[2]][[1]] = matrix(data = 0L, nrow = 11, ncol = 2)
  expect[[6]][[2]][[1]][ 1, 1:2] = c(5L, 1L)
  expect[[6]][[2]][[1]][ 2, 1:2] = c(6L, 10L)
  expect[[6]][[2]][[1]][ 3, 1:2] = c(5L, 20L)
  expect[[6]][[2]][[1]][ 4, 1:2] = c(6L, 30L)
  expect[[6]][[2]][[1]][ 5, 1:2] = c(5L, 40L)
  expect[[6]][[2]][[1]][ 6, 1:2] = c(6L, 50L)
  expect[[6]][[2]][[1]][ 7, 1:2] = c(5L, 60L)
  expect[[6]][[2]][[1]][ 8, 1:2] = c(6L, 70L)
  expect[[6]][[2]][[1]][ 9, 1:2] = c(5L, 80L)
  expect[[6]][[2]][[1]][10, 1:2] = c(6L, 90L)
  expect[[6]][[2]][[1]][11, 1:2] = c(5L, 100L)
  expect[[6]][[2]][[2]] = matrix(data = 0L, nrow = 6, ncol = 2)
  expect[[6]][[2]][[2]][1, 1:2] = c(8L, 1L)
  expect[[6]][[2]][[2]][2, 1:2] = c(7L, 50L)
  expect[[6]][[2]][[2]][3, 1:2] = c(8L, 100L)
  expect[[6]][[2]][[2]][4, 1:2] = c(7L, 150L)
  expect[[6]][[2]][[2]][5, 1:2] = c(8L, 200L)
  expect[[6]][[2]][[2]][6, 1:2] = c(7L, 250L)
  # ind 7
  expect[[7]][[1]][[1]] = matrix(data = 0L, nrow = 12, ncol = 2)
  expect[[7]][[1]][[1]][ 1, 1:2] = c(4L, 1L)
  expect[[7]][[1]][[1]][ 2, 1:2] = c(3L, 5L)
  expect[[7]][[1]][[1]][ 3, 1:2] = c(1L, 6L)
  expect[[7]][[1]][[1]][ 4, 1:2] = c(4L, 10L)
  expect[[7]][[1]][[1]][ 5, 1:2] = c(3L, 15L)
  expect[[7]][[1]][[1]][ 6, 1:2] = c(4L, 20L)
  expect[[7]][[1]][[1]][ 7, 1:2] = c(2L, 45L)
  expect[[7]][[1]][[1]][ 8, 1:2] = c(1L, 50L)
  expect[[7]][[1]][[1]][ 9, 1:2] = c(2L, 100L)
  expect[[7]][[1]][[1]][10, 1:2] = c(4L, 110L)
  expect[[7]][[1]][[1]][11, 1:2] = c(2L, 140L)
  expect[[7]][[1]][[1]][12, 1:2] = c(1L, 150L)
  expect[[7]][[1]][[2]] = matrix(data = 0L, nrow = 5, ncol = 2)
  expect[[7]][[1]][[2]][1, 1:2] = c(8L, 1L)
  expect[[7]][[1]][[2]][2, 1:2] = c(7L, 9L)
  expect[[7]][[1]][[2]][3, 1:2] = c(8L, 11L)
  expect[[7]][[1]][[2]][4, 1:2] = c(7L, 50L)
  expect[[7]][[1]][[2]][5, 1:2] = c(8L, 100L)
  expect[[7]][[2]][[1]] = matrix(data = 0L, nrow = 16, ncol = 2)
  expect[[7]][[2]][[1]][ 1, 1:2] = c(4L, 1L)
  expect[[7]][[2]][[1]][ 2, 1:2] = c(3L, 3L)
  expect[[7]][[2]][[1]][ 3, 1:2] = c(4L, 5L)
  expect[[7]][[2]][[1]][ 4, 1:2] = c(2L, 6L)
  expect[[7]][[2]][[1]][ 5, 1:2] = c(1L, 7L)
  expect[[7]][[2]][[1]][ 6, 1:2] = c(2L, 8L)
  expect[[7]][[2]][[1]][ 7, 1:2] = c(1L, 9L)
  expect[[7]][[2]][[1]][ 8, 1:2] = c(4L, 10L)
  expect[[7]][[2]][[1]][ 9, 1:2] = c(3L, 11L)
  expect[[7]][[2]][[1]][10, 1:2] = c(4L, 13L)
  expect[[7]][[2]][[1]][11, 1:2] = c(3L, 15L)
  expect[[7]][[2]][[1]][12, 1:2] = c(4L, 17L)  
  expect[[7]][[2]][[1]][13, 1:2] = c(3L, 19L)  
  expect[[7]][[2]][[1]][14, 1:2] = c(2L, 45L)  
  expect[[7]][[2]][[1]][15, 1:2] = c(3L, 110L)  
  expect[[7]][[2]][[1]][16, 1:2] = c(2L, 140L)  
  expect[[7]][[2]][[2]] = matrix(data = 0L, nrow = 15, ncol = 2)
  expect[[7]][[2]][[2]][ 1, 1:2] = c(5L, 1L)
  expect[[7]][[2]][[2]][ 2, 1:2] = c(6L, 10L)
  expect[[7]][[2]][[2]][ 3, 1:2] = c(5L, 20L)
  expect[[7]][[2]][[2]][ 4, 1:2] = c(6L, 30L)
  expect[[7]][[2]][[2]][ 5, 1:2] = c(5L, 40L)
  expect[[7]][[2]][[2]][ 6, 1:2] = c(7L, 50L)
  expect[[7]][[2]][[2]][ 7, 1:2] = c(6L, 75L)
  expect[[7]][[2]][[2]][ 8, 1:2] = c(5L, 80L)
  expect[[7]][[2]][[2]][ 9, 1:2] = c(6L, 90L)
  expect[[7]][[2]][[2]][10, 1:2] = c(7L, 99L)
  expect[[7]][[2]][[2]][11, 1:2] = c(8L, 100L)
  expect[[7]][[2]][[2]][12, 1:2] = c(5L, 101L)  
  expect[[7]][[2]][[2]][13, 1:2] = c(8L, 149L)  
  expect[[7]][[2]][[2]][14, 1:2] = c(7L, 150L)  
  expect[[7]][[2]][[2]][15, 1:2] = c(5L, 151L)  
  result = AlphaSimR:::getIbdRecHist(recHist     = recHist,
                                     pedigree    = pedigree,
                                     nLociPerChr = c(300, 300))$ibdRecHist
  for (ind in 1:7) {
    for (chr in 1:2) {
      for (par in 1:2) {
        expect_identical(object = result[[ind]][[chr]][[par]],
                         expected = expect[[ind]][[chr]][[par]],
                         info = paste0("ind ", ind, " chr ", chr, " par ", par))
      }
    }
  }
})
